<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Servicios EM - Registro y B√∫squeda con Firebase</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 15px;
      background: linear-gradient(to bottom, #e3f2fd, #e8f5e9);
      color: #263238;
      margin: 0;
      min-height: 100vh;
    }
    header {
      background-color: #01579b;
      color: white;
      padding: 20px;
      text-align: center;
      border-radius: 0 0 12px 12px;
      margin-bottom: 15px;
    }
    header h1 {
      margin: 0;
      font-size: 2em;
    }
    header p {
      margin: 5px 0 0;
      font-size: 1em;
      font-weight: 500;
    }
    .marquesina {
      background: #ffca28;
      color: #1a237e;
      padding: 10px 0;
      font-weight: bold;
      overflow: hidden;
      white-space: nowrap;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    .marquesina span {
      display: inline-block;
      padding-left: 100%;
      animation: mover 20s linear infinite;
    }
    @keyframes mover {
      0% {
        transform: translateX(0);
      }
      100% {
        transform: translateX(-100%);
      }
    }
    input, button {
      padding: 10px;
      margin: 8px 0;
      font-size: 1em;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    input:focus {
      border-color: #0288d1;
      outline: none;
    }
    button {
      background-color: #0288d1;
      color: white;
      border: none;
      cursor: pointer;
      max-width: 400px;
      border-radius: 10px;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #0277bd;
    }
    h2 {
      color: #01579b;
      margin-top: 30px;
      margin-bottom: 10px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 700px;
      background: #ffffffdd;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px 15px;
      border-bottom: 1px solid #ddd;
      text-align: left;
      font-size: 0.95em;
    }
    th {
      background-color: #0288d1;
      color: white;
      font-weight: 600;
    }
    tr:nth-child(even) {
      background-color: #f1f9ff;
    }
    #registros-dia, #resultados-busqueda {
      margin-top: 10px;
    }
    #resultados-busqueda p, #registros-dia p {
      font-style: italic;
      color: #555;
      max-width: 700px;
    }
    @media (max-width: 480px) {
      input, button {
        max-width: 100%;
      }
      table {
        max-width: 100%;
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Servicios EM</h1>
    <p>Boca de Remedios, Comarca Ng√§be-Bugl√©</p>
  </header>
  <div class="marquesina">
    <span>üåê Servicios EM - Venta de Internet Starlink por hora. ¬°Solo 0.25 por hora! Conexi√≥n r√°pida y confiable. ¬°Gracias por preferirnos! üåü</span>
  </div>

  <h2>Registrar Cliente</h2>
  <input type="text" id="cliente" placeholder="Nombre del cliente" />
  <input type="datetime-local" id="inicio" />
  <input type="datetime-local" id="fin" />
  <button onclick="registrarCliente()">Guardar Registro</button>

  <h2>Registros del d√≠a (persistentes)</h2>
  <div id="registros-dia"><p>Cargando registros...</p></div>

  <h2>Buscar por Cliente</h2>
  <input type="text" id="busqueda-cliente" placeholder="Nombre cliente para buscar" />
  <button onclick="buscarCliente()">Buscar</button>
  <div id="resultados-busqueda"></div>

<script>
  // Configura tu Firebase aqu√≠ (reemplaza con tus datos)
  const firebaseConfig = {
    apiKey: "AIzaSyCMvMidGE3EJMGWTiHwMCeiIFkY7TlNnPk",
    authDomain: "servicios-em.firebaseapp.com",
    projectId: "servicios-em",
    storageBucket: "servicios-em.appspot.com",
    messagingSenderId: "967794596063",
    appId: "1:967794596063:web:9249e6e6e9c4a003eff16a"
  };

  // Inicializa Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Llaves para localStorage
  const LS_KEY = "registros_dia";
  const LS_DAY_KEY = "registros_dia_fecha";

  // Al cargar la p√°gina:
  window.onload = () => {
    checkYLimpiarLocal();
  };

  function checkYLimpiarLocal() {
    const hoyStr = new Date().toISOString().slice(0,10); // 'YYYY-MM-DD'
    const guardadoDia = localStorage.getItem(LS_DAY_KEY);

    if (guardadoDia !== hoyStr) {
      // Nuevo d√≠a, limpiar registros guardados localmente
      localStorage.setItem(LS_KEY, JSON.stringify([]));
      localStorage.setItem(LS_DAY_KEY, hoyStr);
      document.getElementById("registros-dia").innerHTML = "<p>No hay registros para mostrar hoy.</p>";
    } else {
      // Mismo d√≠a, mostrar registros guardados
      const registros = JSON.parse(localStorage.getItem(LS_KEY)) || [];
      if (registros.length) {
        mostrarRegistrosDia(registros);
      } else {
        document.getElementById("registros-dia").innerHTML = "<p>No hay registros para mostrar hoy.</p>";
      }
    }
  }

  function mostrarRegistrosDia(registros) {
    const div = document.getElementById("registros-dia");
    if (!registros.length) {
      div.innerHTML = "<p>No hay registros para mostrar hoy.</p>";
      return;
    }
    let html = `<table>
      <thead>
        <tr><th>Cliente</th><th>Inicio</th><th>Fin</th><th>Horas</th><th>Total</th></tr>
      </thead><tbody>`;
    registros.forEach(r => {
      html += `<tr>
        <td>${r.cliente}</td>
        <td>${r.inicio}</td>
        <td>${r.fin}</td>
        <td>${Number(r.horas).toFixed(2)}</td>
        <td>$${Number(r.total).toFixed(2)}</td>
      </tr>`;
    });
    html += "</tbody></table>";
    div.innerHTML = html;
  }

  function mostrarResultadosBusqueda(registros) {
    const div = document.getElementById("resultados-busqueda");
    if (!registros.length) {
      div.innerHTML = "<p>No se encontraron registros para ese cliente.</p>";
      return;
    }
    let html = `<table>
      <thead>
        <tr><th>Cliente</th><th>Inicio</th><th>Fin</th><th>Horas</th><th>Total</th></tr>
      </thead><tbody>`;
    registros.forEach(r => {
      html += `<tr>
        <td>${r.cliente}</td>
        <td>${r.inicio}</td>
        <td>${r.fin}</td>
        <td>${Number(r.horas).toFixed(2)}</td>
        <td>$${Number(r.total).toFixed(2)}</td>
      </tr>`;
    });
    html += "</tbody></table>";
    div.innerHTML = html;
  }

  // Guarda localmente para mantener la lista del d√≠a
  function guardarLocal(registro) {
    let registros = JSON.parse(localStorage.getItem(LS_KEY)) || [];
    registros.push(registro);
    localStorage.setItem(LS_KEY, JSON.stringify(registros));
  }

  // Funci√≥n para registrar cliente (guardar en Firebase y local)
  function registrarCliente() {
    const cliente = document.getElementById("cliente").value.trim();
    const inicioVal = document.getElementById("inicio").value;
    const finVal = document.getElementById("fin").value;
    if (!cliente || !inicioVal || !finVal) {
      alert("Por favor completa todos los campos.");
      return;
    }
    const inicio = new Date(inicioVal);
    const fin = new Date(finVal);
    if (fin <= inicio) {
      alert("La hora de fin debe ser posterior al inicio.");
      return;
    }
    const horas = (fin - inicio) / (1000 * 60 * 60);
    const total = (horas * 0.25).toFixed(2);

    const registroLocal = {
      cliente,
      inicio: inicio.toLocaleString(),
      fin: fin.toLocaleString(),
      horas: Number(horas.toFixed(2)),
      total: Number(total)
    };

    // Guardar localmente y actualizar tabla diaria
    guardarLocal(registroLocal);
    mostrarRegistrosDia(JSON.parse(localStorage.getItem(LS_KEY)));

    // Guardar en Firebase
    db.collection("registros").add({
      cliente: cliente,
      clienteLower: cliente.toLowerCase(),
      inicio: firebase.firestore.Timestamp.fromDate(inicio),
      fin: firebase.firestore.Timestamp.fromDate(fin),
      horas: Number(horas.toFixed(2)),
      total: Number(total)
    })
    .then(() => {
      alert("Registro guardado correctamente.");
      // Limpiar inputs
      document.getElementById("cliente").value = "";
      document.getElementById("inicio").value = "";
      document.getElementById("fin").value = "";
    })
    .catch((error) => {
      console.error("Error guardando registro:", error);
      alert("Error al guardar el registro.");
    });
  }

  // Buscar cliente solo por nombre (sin fecha)
  function buscarCliente() {
    const clienteBuscado = document.getElementById("busqueda-cliente").value.trim().toLowerCase();
    if (!clienteBuscado) {
      alert("Ingresa un nombre de cliente para buscar.");
      return;
    }

    db.collection("registros")
      .where("clienteLower", "==", clienteBuscado)
      .get()
      .then((querySnapshot) => {
        const resultados = [];
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          resultados.push({
            cliente: data.cliente,
            inicio: data.inicio.toDate().toLocaleString(),
            fin: data.fin.toDate().toLocaleString(),
            horas: data.horas,
            total: data.total
          });
        });

        mostrarResultadosBusqueda(resultados);
      })
      .catch((error) => {
        console.error("Error al buscar:", error);
        alert("Error al buscar los registros.");
      });
  }
</script>
</body>
</html>
