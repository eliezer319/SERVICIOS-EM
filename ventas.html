<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Servicios EM - Inventario y Ventas</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f9f9f9; }
  label { display: block; margin-top: 10px; font-weight: bold; }
  input, select, button, textarea { width: 300px; padding: 6px; margin-top: 4px; }
  table { border-collapse: collapse; width: 100%; margin-top: 15px; }
  table, th, td { border: 1px solid #ccc; }
  th, td { padding: 8px; text-align: left; }
  .error { color: red; font-weight: bold; }
  section { background: #fff; padding: 15px; border: 1px solid #ccc; margin-bottom: 20px; }
  /* Inventario */
  .fila-producto { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; border-radius: 5px; background: #fafafa; }
  .campo-fila { flex: 1 1 140px; min-width: 140px; display: flex; flex-direction: column; }
  .campo-fila label { font-weight: bold; font-size: 0.85em; margin-bottom: 3px; }
  .fila-producto button { flex: 0 0 auto; align-self: center; height: 30px; margin-top: 18px; }
  #calculos-en-vivo { margin-top: 15px; background: #eef; padding: 10px; border-radius: 5px; width: 320px; }
  /* Ventas */
  .fila-venta { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; border-radius: 5px; background: #fafafa; }
  .fila-venta button { flex: 0 0 auto; align-self: center; height: 30px; margin-top: 18px; }
  #ventas-totales { margin-top: 15px; background: #eef; padding: 10px; border-radius: 5px; width: 350px; }
  #venta-cliente-productos { display: flex; gap: 20px; flex-wrap: wrap; }
  #cliente-venta-section { min-width: 300px; }
  #contenedor-filas-ventas { flex: 1; min-width: 350px; }
  #buscar-ventas-resultados { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 8px; background: #fff; }
  /* Tabs */
  .tabs-menu {
    display: flex;
    margin: 0 0 24px 0;
    padding: 0;
    background: #f9f9f9;
    border-bottom: 2px solid #ccc;
  }
  .tab-btn {
    appearance: none;
    border: none;
    outline: none;
    background: none;
    cursor: pointer;
    font-size: 1em;
    font-weight: bold;
    color: #555;
    padding: 12px 32px 10px 32px;
    margin: 0;
    border-bottom: 3px solid transparent;
    transition: background 0.14s, border 0.14s, color 0.14s;
  }
  .tab-btn.active {
    border-bottom: 3px solid #2186eb;
    background: #fff;
    color: #2186eb;
  }
  .tab-section { display: none; }
  .tab-section.active { display: block; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>Servicios EM - Inventario y Ventas</h1>

<!-- Tabs menu -->
<div class="tabs-menu">
  <button class="tab-btn active" onclick="showTab('inventario')">Inventario y Proveedores</button>
  <button class="tab-btn" onclick="showTab('ventas')">Ventas y Clientes</button>
</div>

<!-- TAB 1: INVENTARIO/PROVEEDORES -->
<div id="tab-inventario" class="tab-section active">
  <section>
    <h2>Proveedor</h2>
    <label for="select-proveedor">Selecciona un proveedor existente:</label>
    <select id="select-proveedor">
      <option value="">-- Seleccionar proveedor --</option>
    </select>
    <p>O si no existe, ingresa nuevo proveedor:</p>
    <label for="proveedor-nombre">Nombre:</label>
    <input type="text" id="proveedor-nombre" placeholder="Nombre proveedor" />
    <label for="proveedor-correo">Correo:</label>
    <input type="email" id="proveedor-correo" placeholder="Correo proveedor" />
    <label for="proveedor-direccion">Dirección:</label>
    <textarea id="proveedor-direccion" rows="2" placeholder="Dirección proveedor"></textarea>
    <label for="proveedor-telefono">Teléfono:</label>
    <input type="text" id="proveedor-telefono" placeholder="Teléfono proveedor" />
    <button onclick="registrarProveedor()">Registrar Proveedor Nuevo</button>
    <p id="proveedor-mensaje"></p>
  </section>

  <section>
    <h2>Registro de Inventario - Varios Productos</h2>
    <label for="select-proveedor-inventario">Selecciona el proveedor para todos los productos:</label>
    <select id="select-proveedor-inventario">
      <option value="">-- Seleccionar proveedor --</option>
    </select>
    <div id="contenedor-filas-productos"></div>
    <button onclick="agregarFilaProducto()">Agregar Producto</button>
    <div id="calculos-en-vivo">
      <strong>Cálculos en vivo (suma total de todos los productos):</strong><br/>
      Subtotal: <span id="calc-subtotal">0.00</span><br/>
      ITBMS total: <span id="calc-itbms">0.00</span><br/>
      Descuento total: <span id="calc-descuento">0.00</span><br/>
      Total: <span id="calc-total">0.00</span><br/>
      Saldo pendiente: <span id="calc-saldo">0.00</span><br/>
    </div>
    <button style="margin-top:10px;" onclick="registrarInventarioMultiples()">Registrar / Actualizar Inventario</button>
    <p id="inventario-mensaje"></p>
  </section>

  <section>
    <h2>Buscar Inventario</h2>
    <input type="text" id="buscar-inventario" placeholder="Buscar producto por nombre o código" style="width: 300px;" />
    <button onclick="buscarInventario()">Buscar</button>
    <div id="resultados-inventario" style="margin-top: 10px;"></div>
  </section>

  <section>
    <h2>Productos en Stock</h2>
    <div id="tabla-stock"></div>
  </section>
</div>

<!-- TAB 2: VENTAS/CLIENTES -->
<div id="tab-ventas" class="tab-section">
  <section id="venta-cliente-productos">
    <div id="cliente-venta-section">
      <h2>Cliente para la venta</h2>
      <label for="select-cliente">Selecciona un cliente:</label>
      <select id="select-cliente">
        <option value="">-- Seleccionar cliente --</option>
      </select>
      <p>O ingresa un nuevo cliente:</p>
      <label for="cliente-nombre">Nombre completo:</label>
      <input type="text" id="cliente-nombre" placeholder="Nombre completo" autocomplete="off" />
      <label for="cliente-correo">Correo:</label>
      <input type="email" id="cliente-correo" placeholder="Correo" />
      <label for="cliente-direccion">Dirección:</label>
      <input type="text" id="cliente-direccion" placeholder="Dirección" />
      <label for="cliente-telefono">Teléfono:</label>
      <input type="text" id="cliente-telefono" placeholder="Teléfono" />
      <button onclick="registrarCliente()">Registrar Cliente Nuevo</button>
      <p id="cliente-mensaje"></p>
    </div>
    <div>
      <h2>Agregar Productos a la Venta</h2>
      <div id="contenedor-filas-ventas"></div>
      <button onclick="agregarFilaVenta()">Agregar Producto</button>
      <div id="ventas-totales">
        <strong>Resumen de la venta:</strong><br/>
        Subtotal: <span id="venta-subtotal">0.00</span><br/>
        ITBMS total: <span id="venta-itbms">0.00</span><br/>
        Descuento total: <span id="venta-descuento">0.00</span><br/>
        Total a pagar: <span id="venta-total">0.00</span><br/><br/>
        <label for="forma-pago">Forma de pago:</label>
        <select id="forma-pago" style="width: 200px;">
          <option value="Efectivo">Efectivo</option>
          <option value="Tarjeta">Tarjeta</option>
          <option value="Transferencia">Transferencia</option>
          <option value="Crédito">Crédito</option>
        </select>
        <label for="abono">Abono:</label>
        <input type="number" id="abono" min="0" step="0.01" value="0" />
        <label for="saldo-pendiente">Saldo pendiente:</label>
        <input type="number" id="saldo-pendiente" readonly value="0" />
      </div>
      <button style="margin-top:10px;" onclick="registrarVenta()">Registrar Venta</button>
      <p id="venta-mensaje"></p>
    </div>
  </section>

  <section>
    <h2>Buscar Ventas por Nombre de Cliente</h2>
    <label for="buscar-nombre-ventas">Escribe el nombre del cliente:</label>
    <input type="text" id="buscar-nombre-ventas" placeholder="Ejemplo: Juan Pérez" style="width: 300px;" />
    <button onclick="buscarVentas()">Buscar Ventas</button>
    <div id="buscar-ventas-resultados"></div>
  </section>
</div>

<script>
function showTab(tab) {
  document.querySelectorAll('.tab-btn').forEach((btn, i) => {
    btn.classList.toggle('active', (tab === 'inventario' && i===0) || (tab === 'ventas' && i===1));
  });
  document.getElementById('tab-inventario').classList.toggle('active', tab==='inventario');
  document.getElementById('tab-ventas').classList.toggle('active', tab==='ventas');
}

// --- Configuración Firebase ---
const firebaseConfig = {
  apiKey: "AIzaSyCMvMidGE3EJMGWTiHwMCeiIFkY7TlNnPk",
  authDomain: "servicios-em.firebaseapp.com",
  projectId: "servicios-em",
  storageBucket: "servicios-em.appspot.com",
  messagingSenderId: "967794596063",
  appId: "1:967794596063:web:9249e6e6e9c4a003eff16a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- PROVEEDORES/INVENTARIO ---
async function cargarProveedores() {
  const selects = [document.getElementById('select-proveedor'), document.getElementById('select-proveedor-inventario')];
  for (const select of selects) {
    select.innerHTML = '<option value="">-- Seleccionar proveedor --</option>';
  }
  try {
    const snapshot = await db.collection('proveedores').orderBy('nombre').get();
    snapshot.forEach(doc => {
      const p = doc.data();
      for (const select of selects) {
        const option = document.createElement('option');
        option.value = doc.id;
        option.textContent = p.nombre;
        select.appendChild(option);
      }
    });
  } catch (error) {
    console.error('Error cargando proveedores: ', error);
  }
}
async function registrarProveedor() {
  const nombre = document.getElementById('proveedor-nombre').value.trim();
  const correo = document.getElementById('proveedor-correo').value.trim();
  const direccion = document.getElementById('proveedor-direccion').value.trim();
  const telefono = document.getElementById('proveedor-telefono').value.trim();
  const msg = document.getElementById('proveedor-mensaje');
  msg.textContent = '';

  if (!nombre || !correo || !direccion || !telefono) {
    msg.textContent = 'Por favor, completa todos los campos de proveedor';
    msg.className = 'error';
    return;
  }

  try {
    await db.collection('proveedores').add({
      nombre,
      correo,
      direccion,
      telefono,
      proveedorLower: nombre.toLowerCase(),
      fecha_registro: firebase.firestore.FieldValue.serverTimestamp()
    });
    msg.textContent = 'Proveedor registrado con éxito';
    msg.className = '';
    limpiarCamposProveedor();
    await cargarProveedores();
  } catch (error) {
    msg.textContent = 'Error al registrar proveedor: ' + error.message;
    msg.className = 'error';
  }
}
function limpiarCamposProveedor() {
  document.getElementById('proveedor-nombre').value = '';
  document.getElementById('proveedor-correo').value = '';
  document.getElementById('proveedor-direccion').value = '';
  document.getElementById('proveedor-telefono').value = '';
}
function agregarFilaProducto() {
  const contenedor = document.getElementById('contenedor-filas-productos');
  const fila = document.createElement('div');
  fila.className = 'fila-producto';
  fila.innerHTML = `
    <div class="campo-fila"><label>Producto</label><input type="text" class="producto" placeholder="Producto" autocomplete="off" /></div>
    <div class="campo-fila"><label>Categoría</label><input type="text" class="categoria" placeholder="Categoría" /></div>
    <div class="campo-fila"><label>Código</label><input type="text" class="codigo" placeholder="Código" autocomplete="off" /></div>
    <div class="campo-fila"><label>Costo Unitario</label><input type="number" step="0.01" class="costo_unitario" placeholder="Costo Unitario" /></div>
    <div class="campo-fila"><label>Precio Unitario</label><input type="number" step="0.01" class="precio_unitario" placeholder="Precio Unitario" /></div>
    <div class="campo-fila"><label>Descuento (%)</label><input type="number" step="0.01" class="descuento" placeholder="Descuento (%)" /></div>
    <div class="campo-fila"><label>ITBMS (%)</label><input type="number" step="0.01" class="itbms" placeholder="ITBMS (%)" /></div>
    <div class="campo-fila"><label>Stock Inicial</label><input type="number" class="stock_inicial" placeholder="Stock Inicial" /></div>
    <div class="campo-fila"><label>Tipo</label><input type="text" class="tipo" placeholder="Tipo" /></div>
    <div class="campo-fila"><label>Unidad</label><input type="text" class="unidad" placeholder="Unidad" /></div>
    <div class="campo-fila"><label>Abono</label><input type="number" step="0.01" class="abono" placeholder="Abono" /></div>
    <div class="campo-fila"><label>Forma de pago</label><input type="text" class="formaPago" placeholder="Forma de pago" /></div>
    <button type="button" onclick="eliminarFilaProducto(this)">Eliminar</button>
  `;
  contenedor.appendChild(fila);
  agregarEventosFila(fila);
  agregarAutorelleno(fila);
}
function eliminarFilaProducto(btn) {
  const fila = btn.parentElement;
  fila.remove();
  actualizarCalculosEnVivo();
}

// INTEGRADO: Cambia la lógica de actualización de stock aquí
async function actualizarStock(productoLower, cantidadNueva, datosProducto) {
  try {
    // Busca el documento stock
    const stockDocQuery = await db.collection('stock').where('productoLower', '==', productoLower).limit(1).get();
    if (!stockDocQuery.empty) {
      // Si existe, suma la cantidad
      const docRef = stockDocQuery.docs[0].ref;
      const stockActual = stockDocQuery.docs[0].data().cantidad || 0;
      await docRef.update({
        cantidad: stockActual + cantidadNueva,
        // Actualiza otros datos relevantes si lo deseas
        categoria: datosProducto.categoria || '',
        codigo: datosProducto.codigo || '',
        costo_promedio: datosProducto.costo_unitario || 0,
        descuento: datosProducto.descuento || 0,
        itbms: datosProducto.itbms || 0,
        precio_unitario: datosProducto.precio_unitario || 0,
        tipo: datosProducto.tipo || '',
        unidad: datosProducto.unidad || '',
        stock: cantidadNueva,
        fecha_actualizacion: firebase.firestore.FieldValue.serverTimestamp()
      });
    } else {
      // Si no existe, crea el documento stock
      await db.collection('stock').add({
        producto: datosProducto.producto,
        productoLower,
        categoria: datosProducto.categoria || '',
        codigo: datosProducto.codigo || '',
        costo_promedio: datosProducto.costo_unitario || 0,
        descuento: datosProducto.descuento || 0,
        itbms: datosProducto.itbms || 0,
        precio_unitario: datosProducto.precio_unitario || 0,
        tipo: datosProducto.tipo || '',
        unidad: datosProducto.unidad || '',
        cantidad: cantidadNueva,
        stock: cantidadNueva,
        fecha_actualizacion: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    cargarStock();
  } catch (error) {
    console.error('Error actualizando stock:', error);
  }
}

// Cambia el registro de inventario para pasar los datos correctos a actualizarStock
async function registrarInventarioMultiples() {
  const proveedorSelect = document.getElementById('select-proveedor-inventario');
  const proveedorId = proveedorSelect.value;
  const proveedorNombre = proveedorSelect.selectedOptions[0]?.text || '';
  const msg = document.getElementById('inventario-mensaje');
  msg.textContent = '';
  msg.className = '';

  if (!proveedorId) {
    msg.textContent = 'Por favor, selecciona un proveedor para los productos';
    msg.className = 'error';
    return;
  }

  const filas = document.querySelectorAll('#contenedor-filas-productos .fila-producto');
  if (filas.length === 0) {
    msg.textContent = 'Agrega al menos un producto para registrar';
    msg.className = 'error';
    return;
  }

  let todoBien = true;
  for (const fila of filas) {
    const producto = fila.querySelector('input.producto').value.trim();
    const categoria = fila.querySelector('input.categoria').value.trim();
    const codigo = fila.querySelector('input.codigo').value.trim();
    const costo_unitario = parseFloat(fila.querySelector('input.costo_unitario').value);
    const precio_unitario = parseFloat(fila.querySelector('input.precio_unitario').value);
    const descuento = parseFloat(fila.querySelector('input.descuento').value);
    const itbms = parseFloat(fila.querySelector('input.itbms').value);
    const stock_inicial = parseInt(fila.querySelector('input.stock_inicial').value);
    const tipo = fila.querySelector('input.tipo').value.trim();
    const unidad = fila.querySelector('input.unidad').value.trim();
    const abono = parseFloat(fila.querySelector('input.abono').value) || 0;
    const formaPago = fila.querySelector('input.formaPago').value.trim();

    if (!producto || !categoria || !codigo || isNaN(costo_unitario) || isNaN(precio_unitario) || isNaN(descuento) || isNaN(itbms) || isNaN(stock_inicial) || !tipo || !unidad) {
      todoBien = false;
      break;
    }

    try {
      await db.collection('inventario').add({
        producto, categoria, codigo, costo_unitario, precio_unitario, descuento, itbms, stock_inicial, tipo, unidad,
        proveedorId, proveedorNombre, productoLower: producto.toLowerCase(), abono,
        saldo_pendiente: (costo_unitario * stock_inicial + ((costo_unitario * stock_inicial) * (itbms / 100)) - ((costo_unitario * stock_inicial) * (descuento / 100))) - abono,
        formaPago, fecha_actualizacion: firebase.firestore.FieldValue.serverTimestamp()
      });
      // Aquí PASA SOLO EL LOTE NUEVO
      await actualizarStock(
        producto.toLowerCase(),
        stock_inicial,
        { producto, categoria, codigo, costo_unitario, precio_unitario, descuento, itbms, tipo, unidad }
      );
    } catch (error) {
      console.error('Error registrando producto: ', error);
      todoBien = false;
    }
  }

  if (todoBien) {
    msg.textContent = 'Inventario registrado/actualizado con éxito.';
    limpiarFilasProductos();
    cargarStock();
    actualizarCalculosEnVivo();
  } else {
    msg.textContent = 'Error en algunos datos. Revisa e intenta de nuevo.';
    msg.className = 'error';
  }
}

function limpiarFilasProductos() {
  const contenedor = document.getElementById('contenedor-filas-productos');
  contenedor.innerHTML = '';
}
async function cargarStock() {
  const divStock = document.getElementById('tabla-stock');
  divStock.innerHTML = '<p>Cargando stock...</p>';
  try {
    const snapshot = await db.collection('stock').orderBy('producto').get();
    if (snapshot.empty) {
      divStock.innerHTML = '<p>No hay productos en stock.</p>';
      return;
    }
    let html = `<table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>Código</th>
          <th>Categoría</th>
          <th>Tipo</th>
          <th>Unidad</th>
          <th>Cantidad</th>
          <th>Precio Unitario</th>
          <th>ITBMS (%)</th>
          <th>Descuento (%)</th>
        </tr>
      </thead><tbody>`;
    snapshot.forEach(doc => {
      const d = doc.data();
      html += `<tr>
        <td>${d.producto || ''}</td>
        <td>${d.codigo || ''}</td>
        <td>${d.categoria || ''}</td>
        <td>${d.tipo || ''}</td>
        <td>${d.unidad || ''}</td>
        <td>${d.cantidad ?? 0}</td>
        <td>${d.precio_unitario?.toFixed(2) ?? '0.00'}</td>
        <td>${d.itbms?.toFixed(2) ?? '0.00'}</td>
        <td>${d.descuento?.toFixed(2) ?? '0.00'}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    divStock.innerHTML = html;
  } catch (e) {
    divStock.innerHTML = '<p>Error cargando stock.</p>';
    console.error(e);
  }
}
async function buscarInventario() {
  const busqueda = document.getElementById('buscar-inventario').value.trim().toLowerCase();
  const divResultados = document.getElementById('resultados-inventario');
  divResultados.innerHTML = '<p>Buscando...</p>';
  if (!busqueda) {
    divResultados.innerHTML = '<p>Ingresa texto para buscar.</p>';
    return;
  }
  try {
    const query1 = db.collection('inventario').where('productoLower', '>=', busqueda).where('productoLower', '<=', busqueda + '\uf8ff');
    const query2 = db.collection('inventario').where('codigo', '==', busqueda);
    const [snap1, snap2] = await Promise.all([query1.get(), query2.get()]);
    const resultados = [];
    snap1.forEach(doc => resultados.push({ id: doc.id, data: doc.data() }));
    snap2.forEach(doc => {
      if (!resultados.some(r => r.id === doc.id)) resultados.push({ id: doc.id, data: doc.data() });
    });
    if (resultados.length === 0) {
      divResultados.innerHTML = '<p>No se encontraron resultados.</p>';
      return;
    }
    let html = '<table><thead><tr><th>Producto</th><th>Categoría</th><th>Código</th><th>Costo Unitario</th><th>Precio Unitario</th><th>Stock Inicial</th><th>Proveedor</th></tr></thead><tbody>';
    resultados.forEach(r => {
      const d = r.data;
      html += `<tr>
        <td>${d.producto || ''}</td>
        <td>${d.categoria || ''}</td>
        <td>${d.codigo || ''}</td>
        <td>${d.costo_unitario || 0}</td>
        <td>${d.precio_unitario || 0}</td>
        <td>${d.stock_inicial || 0}</td>
        <td>${d.proveedorNombre || ''}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    divResultados.innerHTML = html;
  } catch (error) {
    divResultados.innerHTML = '<p class="error">Error en la búsqueda: ' + error.message + '</p>';
  }
}
function agregarEventosFila(fila) {
  const inputs = fila.querySelectorAll('input');
  inputs.forEach(input => { input.addEventListener('input', actualizarCalculosEnVivo); });
}
function agregarAutorelleno(fila) {
  const inputProducto = fila.querySelector('input.producto');
  const inputCodigo = fila.querySelector('input.codigo');
  inputProducto.addEventListener('input', async () => {
    const val = inputProducto.value.trim().toLowerCase();
    if (!val) return;
    try {
      const snapshot = await db.collection('inventario').where('productoLower', '==', val).limit(1).get();
      if (!snapshot.empty) rellenarFilaConDatos(fila, snapshot.docs[0].data());
    } catch (e) { console.error('Error autorelleno producto:', e); }
  });
  inputCodigo.addEventListener('input', async () => {
    const val = inputCodigo.value.trim();
    if (!val) return;
    try {
      const snapshot = await db.collection('inventario').where('codigo', '==', val).limit(1).get();
      if (!snapshot.empty) rellenarFilaConDatos(fila, snapshot.docs[0].data());
    } catch (e) { console.error('Error autorelleno código:', e); }
  });
}
function rellenarFilaConDatos(fila, data) {
  fila.querySelector('input.producto').value = data.producto || '';
  fila.querySelector('input.categoria').value = data.categoria || '';
  fila.querySelector('input.codigo').value = data.codigo || '';
  fila.querySelector('input.costo_unitario').value = data.costo_unitario || 0;
  fila.querySelector('input.precio_unitario').value = data.precio_unitario || 0;
  fila.querySelector('input.descuento').value = data.descuento || 0;
  fila.querySelector('input.itbms').value = data.itbms || 0;
  fila.querySelector('input.stock_inicial').value = data.stock_inicial || 0;
  fila.querySelector('input.tipo').value = data.tipo || '';
  fila.querySelector('input.unidad').value = data.unidad || '';
  actualizarCalculosEnVivo();
}
// --- CLIENTES/VENTAS ---

// Aquí está la integración para pedir fechas solo para Internet Starlink
function agregarFilaVenta() {
  const contenedor = document.getElementById('contenedor-filas-ventas');
  const fila = document.createElement('div');
  fila.className = 'fila-venta';
  fila.innerHTML = `
    <div class="campo-fila"><label>Producto (Nombre)</label><input type="text" class="producto" autocomplete="off" placeholder="Producto" /></div>
    <div class="campo-fila"><label>Código</label><input type="text" class="codigo" autocomplete="off" placeholder="Código" /></div>
    <div class="campo-fila"><label>Categoría</label><input type="text" class="categoria" readonly /></div>
    <div class="campo-fila"><label>Tipo</label><input type="text" class="tipo" readonly /></div>
    <div class="campo-fila"><label>Unidad</label><input type="text" class="unidad" readonly /></div>
    <div class="campo-fila"><label>Cantidad</label><input type="number" class="cantidad" min="1" value="1" /></div>
    <div class="campo-fila"><label>Precio Unitario</label><input type="number" class="precio_unitario" step="0.01" readonly /></div>
    <div class="campo-fila"><label>Descuento (%)</label><input type="number" class="descuento" step="0.01" value="0" /></div>
    <div class="campo-fila"><label>ITBMS (%)</label><input type="number" class="itbms" step="0.01" /></div>
    <div class="campo-fila"><label>Subtotal</label><input type="number" class="subtotal" step="0.01" readonly /></div>
    <!-- Campos especiales para Starlink, ocultos por defecto -->
    <div class="campo-fila starlink-fechas" style="display:none;">
      <label>Inicio (Fecha y Hora)</label>
      <input type="datetime-local" class="starlink-inicio" />
    </div>
    <div class="campo-fila starlink-fechas" style="display:none;">
      <label>Fin (Fecha y Hora)</label>
      <input type="datetime-local" class="starlink-fin" />
    </div>
    <button type="button" onclick="eliminarFilaVenta(this)">Eliminar</button>
  `;
  contenedor.appendChild(fila);
  agregarEventosVenta(fila);
  agregarAutorellenoVenta(fila);
  actualizarTotales();

  // Evento para mostrar campos extra si es Starlink
  fila.querySelector('input.producto').addEventListener('input', () => {
    mostrarCamposStarlinkSiCorresponde(fila);
  });
}

function mostrarCamposStarlinkSiCorresponde(fila) {
  const prod = fila.querySelector('input.producto').value.trim().toLowerCase();
  const starlinkFields = fila.querySelectorAll('.starlink-fechas');
  if (prod.includes('starlink')) {
    starlinkFields.forEach(f => f.style.display = '');
  } else {
    starlinkFields.forEach(f => f.style.display = 'none');
  }
}

function eliminarFilaVenta(btn) {
  btn.parentElement.remove();
  actualizarTotales();
}
function agregarEventosVenta(fila) {
  const inputs = fila.querySelectorAll('input.cantidad, input.descuento, input.itbms');
  inputs.forEach(input => {
    input.addEventListener('input', () => {
      actualizarSubtotalFila(fila);
      actualizarTotales();
    });
  });
}
function actualizarSubtotalFila(fila) {
  const precio = parseFloat(fila.querySelector('input.precio_unitario').value) || 0;
  const cantidad = parseInt(fila.querySelector('input.cantidad').value) || 0;
  const descuento = parseFloat(fila.querySelector('input.descuento').value) || 0;
  const itbms = parseFloat(fila.querySelector('input.itbms').value) || 0;
  let subtotal = precio * cantidad;
  const descuentoMonto = subtotal * (descuento / 100);
  const itbmsMonto = (subtotal - descuentoMonto) * (itbms / 100);
  const total = subtotal - descuentoMonto + itbmsMonto;
  fila.querySelector('input.subtotal').value = total.toFixed(2);
}
function actualizarTotales() {
  const filas = document.querySelectorAll('#contenedor-filas-ventas .fila-venta');
  let subtotalTotal = 0;
  let descuentoTotal = 0;
  let itbmsTotal = 0;
  filas.forEach(fila => {
    const precio = parseFloat(fila.querySelector('input.precio_unitario').value) || 0;
    const cantidad = parseInt(fila.querySelector('input.cantidad').value) || 0;
    const descuento = parseFloat(fila.querySelector('input.descuento').value) || 0;
    const itbms = parseFloat(fila.querySelector('input.itbms').value) || 0;
    let subtotal = precio * cantidad;
    let descuentoMonto = subtotal * (descuento / 100);
    let itbmsMonto = (subtotal - descuentoMonto) * (itbms / 100);
    subtotalTotal += subtotal;
    descuentoTotal += descuentoMonto;
    itbmsTotal += itbmsMonto;
  });
  let total = subtotalTotal - descuentoTotal + itbmsTotal;
  document.getElementById('venta-subtotal').textContent = subtotalTotal.toFixed(2);
  document.getElementById('venta-descuento').textContent = descuentoTotal.toFixed(2);
  document.getElementById('venta-itbms').textContent = itbmsTotal.toFixed(2);
  document.getElementById('venta-total').textContent = total.toFixed(2);
  const abono = parseFloat(document.getElementById('abono').value) || 0;
  const saldo = total - abono;
  document.getElementById('saldo-pendiente').value = saldo.toFixed(2);
}
document.getElementById('abono').addEventListener('input', () => { actualizarTotales(); });

function agregarAutorellenoVenta(fila) {
  const inputProducto = fila.querySelector('input.producto');
  const inputCodigo = fila.querySelector('input.codigo');
  inputProducto.addEventListener('input', async () => {
    const val = inputProducto.value.trim().toLowerCase();
    if (!val) return;
    try {
      const snapshot = await db.collection('stock').where('productoLower', '==', val).limit(1).get();
      if (!snapshot.empty) rellenarFilaVenta(fila, snapshot.docs[0].data());
    } catch (e) { console.error('Error autorelleno producto venta:', e); }
  });
  inputCodigo.addEventListener('input', async () => {
    const val = inputCodigo.value.trim();
    if (!val) return;
    try {
      const snapshot = await db.collection('stock').where('codigo', '==', val).limit(1).get();
      if (!snapshot.empty) rellenarFilaVenta(fila, snapshot.docs[0].data());
    } catch (e) { console.error('Error autorelleno código venta:', e); }
  });
}

// Ajuste aquí: también mostrar los campos de fecha/hora si se autocompleta la fila
function rellenarFilaVenta(fila, data) {
  fila.querySelector('input.producto').value = data.producto || '';
  fila.querySelector('input.codigo').value = data.codigo || '';
  fila.querySelector('input.categoria').value = data.categoria || '';
  fila.querySelector('input.tipo').value = data.tipo || '';
  fila.querySelector('input.unidad').value = data.unidad || '';
  fila.querySelector('input.precio_unitario').value = data.precio_unitario?.toFixed(2) || '0.00';
  fila.querySelector('input.itbms').value = data.itbms?.toFixed(2) || '0.00';
  fila.querySelector('input.descuento').value = data.descuento?.toFixed(2) || '0.00';
  actualizarSubtotalFila(fila);
  actualizarTotales();

  // MOSTRAR los campos de fecha/hora si el producto es Starlink, ocultar si no
  mostrarCamposStarlinkSiCorresponde(fila);
}

async function cargarClientes() {
  const select = document.getElementById('select-cliente');
  select.innerHTML = '<option value="">-- Seleccionar cliente --</option>';
  try {
    const snapshot = await db.collection('clientes').orderBy('nombre').get();
    snapshot.forEach(doc => {
      const c = doc.data();
      const option = document.createElement('option');
      option.value = doc.id;
      option.textContent = c.nombre;
      select.appendChild(option);
    });
  } catch (error) {
    console.error('Error cargando clientes:', error);
  }
}
async function registrarCliente() {
  const nombre = document.getElementById('cliente-nombre').value.trim();
  const correo = document.getElementById('cliente-correo').value.trim();
  const direccion = document.getElementById('cliente-direccion').value.trim();
  const telefono = document.getElementById('cliente-telefono').value.trim();
  const msg = document.getElementById('cliente-mensaje');
  msg.textContent = '';
  msg.className = '';
  if (!nombre || !correo || !direccion || !telefono) {
    msg.textContent = 'Completa todos los campos del cliente';
    msg.className = 'error';
    return;
  }
  try {
    await db.collection('clientes').add({
      nombre,
      clienteLower: nombre.toLowerCase(),
      correo,
      direccion,
      telefono,
      fecha_registro: firebase.firestore.FieldValue.serverTimestamp()
    });
    msg.textContent = 'Cliente registrado con éxito';
    msg.className = '';
    limpiarCamposCliente();
    await cargarClientes();
  } catch (e) {
    msg.textContent = 'Error al registrar cliente: ' + e.message;
    msg.className = 'error';
  }
}
function limpiarCamposCliente() {
  document.getElementById('cliente-nombre').value = '';
  document.getElementById('cliente-correo').value = '';
  document.getElementById('cliente-direccion').value = '';
  document.getElementById('cliente-telefono').value = '';
}

async function registrarVenta() {
  const clienteId = document.getElementById('select-cliente').value;
  const formaPago = document.getElementById('forma-pago').value;
  const abono = parseFloat(document.getElementById('abono').value) || 0;
  const saldoPendiente = parseFloat(document.getElementById('saldo-pendiente').value) || 0;
  const msg = document.getElementById('venta-mensaje');
  msg.textContent = '';
  msg.className = '';
  if (!clienteId) {
    msg.textContent = 'Selecciona un cliente para la venta';
    msg.className = 'error';
    return;
  }
  const filas = document.querySelectorAll('#contenedor-filas-ventas .fila-venta');
  if (filas.length === 0) {
    msg.textContent = 'Agrega al menos un producto a la venta';
    msg.className = 'error';
    return;
  }
  try {
    const clienteDoc = await db.collection('clientes').doc(clienteId).get();
    if (!clienteDoc.exists) {
      msg.textContent = 'Cliente no encontrado';
      msg.className = 'error';
      return;
    }
    const clienteData = clienteDoc.data();
    let productosVenta = [];
    const batch = db.batch();
    for (const fila of filas) {
      const producto = fila.querySelector('input.producto').value.trim();
      const codigo = fila.querySelector('input.codigo').value.trim();
      const categoria = fila.querySelector('input.categoria').value.trim();
      const tipo = fila.querySelector('input.tipo').value.trim();
      const unidad = fila.querySelector('input.unidad').value.trim();
      const cantidad = parseInt(fila.querySelector('input.cantidad').value) || 0;
      const precio_unitario = parseFloat(fila.querySelector('input.precio_unitario').value) || 0;
      const descuento = parseFloat(fila.querySelector('input.descuento').value) || 0;
      const itbms = parseFloat(fila.querySelector('input.itbms').value) || 0;
      const subtotal = parseFloat(fila.querySelector('input.subtotal').value) || 0;

      // Solo para Internet Starlink, pide fechas y las guarda en el objeto
      let starlink_inicio = null, starlink_fin = null;
      if (producto.toLowerCase().includes('starlink')) {
        starlink_inicio = fila.querySelector('input.starlink-inicio').value;
        starlink_fin = fila.querySelector('input.starlink-fin').value;
        if (!starlink_inicio || !starlink_fin) {
          msg.textContent = 'Debes ingresar fecha y hora de inicio y fin para Internet Starlink.';
          msg.className = 'error';
          return;
        }
      }

      // Stock y validación como siempre
      if (cantidad <= 0) {
        msg.textContent = `Cantidad inválida para el producto "${producto}"`;
        msg.className = 'error';
        return;
      }
      if (!producto) {
        msg.textContent = 'Producto vacío en una fila';
        msg.className = 'error';
        return;
      }
      const stockQuery = await db.collection('stock').where('codigo', '==', codigo).limit(1).get();
      if (stockQuery.empty) {
        msg.textContent = `Producto "${producto}" con código "${codigo}" no existe en stock`;
        msg.className = 'error';
        return;
      }
      const stockDoc = stockQuery.docs[0];
      const stockData = stockDoc.data();
      if (stockData.cantidad < cantidad) {
        msg.textContent = `No hay suficiente stock para "${producto}". Disponible: ${stockData.cantidad}, solicitado: ${cantidad}`;
        msg.className = 'error';
        return;
      }

      productosVenta.push({
        producto, codigo, categoria, tipo, unidad, cantidad, precio_unitario, descuento, itbms, subtotal, stockId: stockDoc.id,
        ...(starlink_inicio && { starlink_inicio }),
        ...(starlink_fin && { starlink_fin })
      });
    }
    const ventaRef = db.collection('ventas').doc();
    const ventaData = {
      clienteId,
      clienteNombre: clienteData.nombre,
      productos: productosVenta.map(p => { const copy = {...p}; delete copy.stockId; return copy; }),
      subtotal: parseFloat(document.getElementById('venta-subtotal').textContent),
      descuento: parseFloat(document.getElementById('venta-descuento').textContent),
      itbms: parseFloat(document.getElementById('venta-itbms').textContent),
      total: parseFloat(document.getElementById('venta-total').textContent),
      formaPago,
      abono,
      saldoPendiente,
      fecha: firebase.firestore.FieldValue.serverTimestamp()
    };
    batch.set(ventaRef, ventaData);
    productosVenta.forEach(p => {
      const stockRef = db.collection('stock').doc(p.stockId);
      batch.update(stockRef, {
        cantidad: firebase.firestore.FieldValue.increment(-p.cantidad)
      });
    });
    await batch.commit();
    msg.textContent = 'Venta registrada correctamente y stock actualizado.';
    msg.className = '';
    limpiarFormularioVenta();
    cargarStock();
    cargarClientes();
  } catch (e) {
    msg.textContent = 'Error al registrar la venta: ' + e.message;
    msg.className = 'error';
    console.error(e);
  }
}
function limpiarFormularioVenta() {
  document.getElementById('select-cliente').value = '';
  document.getElementById('contenedor-filas-ventas').innerHTML = '';
  document.getElementById('venta-subtotal').textContent = '0.00';
  document.getElementById('venta-descuento').textContent = '0.00';
  document.getElementById('venta-itbms').textContent = '0.00';
  document.getElementById('venta-total').textContent = '0.00';
  document.getElementById('forma-pago').value = 'Efectivo';
  document.getElementById('abono').value = 0;
  document.getElementById('saldo-pendiente').value = 0;
}
async function buscarVentas() {
  const nombreBusqueda = document.getElementById('buscar-nombre-ventas').value.trim().toLowerCase();
  const resultadosDiv = document.getElementById('buscar-ventas-resultados');
  resultadosDiv.innerHTML = '';
  if (!nombreBusqueda) {
    resultadosDiv.innerHTML = '<p>Escribe un nombre para buscar ventas.</p>';
    return;
  }
  resultadosDiv.innerHTML = '<em>Buscando ventas...</em>';
  try {
    const ventasSnapshot = await db.collection('ventas').orderBy('fecha', 'desc').limit(100).get();
    const ventasFiltradas = ventasSnapshot.docs.filter(doc => {
      const data = doc.data();
      return data.clienteNombre && data.clienteNombre.toLowerCase().includes(nombreBusqueda);
    });
    if (ventasFiltradas.length === 0) {
      resultadosDiv.innerHTML = '<p>No se encontraron ventas para ese nombre.</p>';
      return;
    }
    let html = '<table><thead><tr><th>Fecha</th><th>Cliente</th><th>Productos</th><th>Total</th><th>Forma Pago</th><th>Abono</th><th>Saldo Pendiente</th></tr></thead><tbody>';
    ventasFiltradas.forEach(doc => {
      const v = doc.data();
      const fecha = v.fecha ? new Date(v.fecha.seconds * 1000).toLocaleString() : 'Sin fecha';
      const productos = v.productos.map(p => {
        if (p.starlink_inicio && p.starlink_fin) {
          return `${p.producto} (${p.cantidad})<br><small>${p.starlink_inicio} - ${p.starlink_fin}</small>`;
        }
        return `${p.producto} (${p.cantidad})`;
      }).join(', ');
      html += `<tr>
        <td>${fecha}</td>
        <td>${v.clienteNombre || ''}</td>
        <td>${productos}</td>
        <td>${v.total?.toFixed(2) ?? '0.00'}</td>
        <td>${v.formaPago || ''}</td>
        <td>${v.abono?.toFixed(2) ?? '0.00'}</td>
        <td>${v.saldoPendiente?.toFixed(2) ?? '0.00'}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    resultadosDiv.innerHTML = html;
  } catch (e) {
    resultadosDiv.innerHTML = '<p>Error al buscar ventas.</p>';
    console.error(e);
  }
}

// --- INICIALIZACIÓN ---
window.onload = function() {
  cargarProveedores();
  cargarClientes();
  cargarStock();
  agregarFilaProducto();
  agregarFilaVenta();
};
</script>

</body>
</html>